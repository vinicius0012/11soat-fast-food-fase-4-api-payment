name: Toten Node.js CI/CD

on:
  push:
    branches: [develop, main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  eslint:
    name: ESlint Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      - run: npm ci
      - run: npm run lint

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      - run: npm ci
      - run: npx tsc --noEmit

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      - run: npm ci

      - name: Run tests with coverage (lcov)
        run: yarn test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [eslint, typecheck, test]
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: Debug coverage path
        run: |
          echo "PWD=$(pwd)"
          echo "Listing coverage folder:"
          ls -la coverage || true
          echo "First lines of coverage/lcov.info:"
          test -f coverage/lcov.info && head -n 20 coverage/lcov.info || echo "coverage/lcov.info NOT FOUND"

      - name: Sonar Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [eslint, typecheck, sonarcloud]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_tag: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      - run: npm ci

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Get generated version
        id: get_version
        run: |
          if git describe --tags --abbrev=0 2>/dev/null; then
            VERSION=$(git describe --tags --abbrev=0)
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
          fi

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: semantic-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE_NAME_ECR }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: gha-ecr

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        run: |
          VERSION="${{ needs.semantic-release.outputs.new_tag }}"
          if [ -z "$VERSION" ]; then
            VERSION="latest"
          fi

          docker build -t ${{ secrets.ECR_REPOSITORY }}:$VERSION .
          docker push ${{ secrets.ECR_REPOSITORY }}:$VERSION

          docker tag ${{ secrets.ECR_REPOSITORY }}:$VERSION ${{ secrets.ECR_REPOSITORY }}:latest
          docker push ${{ secrets.ECR_REPOSITORY }}:latest

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN_DEPLOY }}
          aws-region: ${{ vars.AWS_REGION || secrets.AWS_REGION }}
          role-session-name: gha-deploy

      - name: Install kubectl
        run: |
          set -e
          VER=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          curl -LO "https://dl.k8s.io/release/${VER}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name "${{ secrets.EKS_CLUSTER_NAME }}" \
            --region "${{ vars.AWS_REGION || secrets.AWS_REGION }}" \
            --alias eks-cluster

      - name: Ensure namespace
        run: |
          kubectl get namespace fastfood || kubectl create namespace fastfood

      - name: Rollout restart
        run: |
          kubectl -n fastfood rollout restart deployment/fastfood-app
          kubectl -n fastfood get pods -o wide
